<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Searchable archive of American Sentinel articles on religious liberty and church-state separation, 1886-1900. Browse by principle, author, year, or keyword.">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="{SITE_TITLE}">
    <meta property="og:description" content="Historical writings on religious liberty and church-state separation, 1886-1900">
    <meta property="og:type" content="website">
    <title>{SITE_TITLE}</title>
    <noscript>
        <style>.app-root{display:none!important}</style>
    </noscript>
    <style>
        /* ================================================================
           CSS RESET & CUSTOM PROPERTIES
           ================================================================ */
        :root {
            --color-navy: #2c3e50;
            --color-navy-dark: #1a252f;
            --color-blue: #3498db;
            --color-blue-hover: #2980b9;
            --color-blue-light: #e8f4f8;
            --color-bg: #f8f9fa;
            --color-card: #ffffff;
            --color-text: #2d3436;
            --color-text-secondary: #636e72;
            --color-text-muted: #95a5a6;
            --color-border: #dfe6e9;
            --color-border-light: #ecf0f1;
            --color-tag-principle-bg: #dbeafe;
            --color-tag-principle-text: #1e40af;
            --color-tag-application-bg: #e5e7eb;
            --color-tag-application-text: #374151;
            --color-tag-keyword-bg: #f3f4f6;
            --color-tag-keyword-text: #6b7280;
            --color-success: #27ae60;
            --color-error: #e74c3c;
            --sidebar-width: 300px;
            --header-height: auto;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ================================================================
           TYPOGRAPHY
           ================================================================ */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.3;
            font-weight: 700;
        }

        a {
            color: var(--color-blue);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--color-blue-hover);
        }

        /* ================================================================
           HEADER
           ================================================================ */
        .site-header {
            background: var(--color-navy);
            color: #ffffff;
            padding: 1.25rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: relative;
            z-index: 100;
        }

        .site-header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .site-header .back-link {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: color var(--transition-fast);
            white-space: nowrap;
        }

        .site-header .back-link:hover {
            color: #ffffff;
        }

        .site-header h1 {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 0.01em;
            margin-bottom: 0.2rem;
        }

        .site-header .subtitle {
            font-size: 0.875rem;
            opacity: 0.75;
            font-style: italic;
            line-height: 1.4;
        }

        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            line-height: 1;
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
        }

        .hamburger-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* ================================================================
           LAYOUT: SIDEBAR + MAIN
           ================================================================ */
        .app-layout {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* ================================================================
           SIDEBAR
           ================================================================ */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--color-card);
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
            padding: 0;
            z-index: 50;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar-inner {
            padding: 1rem 0;
        }

        .sidebar-section {
            margin-bottom: 0.25rem;
        }

        .sidebar-heading {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            padding: 1rem 1.25rem 0.4rem;
            user-select: none;
        }

        .sidebar-list {
            list-style: none;
        }

        .sidebar-list li {
            position: relative;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 1.25rem;
            color: var(--color-text);
            font-size: 0.875rem;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: background var(--transition-fast), border-color var(--transition-fast);
            cursor: pointer;
            user-select: none;
        }

        .sidebar-link:hover {
            background: var(--color-bg);
            color: var(--color-text);
        }

        .sidebar-link.active {
            background: var(--color-blue-light);
            color: var(--color-blue-hover);
            border-left-color: var(--color-blue);
            font-weight: 600;
        }

        .sidebar-link .count {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-text-muted);
            background: var(--color-bg);
            padding: 0.1rem 0.45rem;
            border-radius: 10px;
            min-width: 1.6rem;
            text-align: center;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .sidebar-link.active .count {
            background: rgba(52,152,219,0.15);
            color: var(--color-blue-hover);
        }

        /* Expandable principle groups */
        .sidebar-link .expand-icon {
            display: inline-block;
            width: 1em;
            font-size: 0.65em;
            margin-right: 0.35em;
            transition: transform var(--transition-fast);
            flex-shrink: 0;
            text-align: center;
        }

        .sidebar-link .expand-icon.open {
            transform: rotate(90deg);
        }

        .sidebar-link .label {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sub-list {
            list-style: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sub-list.open {
            max-height: 600px;
        }

        .sub-list .sidebar-link {
            padding-left: 2.5rem;
            font-size: 0.82rem;
            color: var(--color-text-secondary);
        }

        .sub-list .sidebar-link:hover {
            color: var(--color-text);
        }

        .sub-list .sidebar-link.active {
            color: var(--color-blue-hover);
        }

        .sidebar-divider {
            border: none;
            border-top: 1px solid var(--color-border-light);
            margin: 0.5rem 1.25rem;
        }

        /* ================================================================
           MOBILE SIDEBAR OVERLAY
           ================================================================ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 40;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .sidebar-overlay.visible {
            opacity: 1;
        }

        /* ================================================================
           MAIN CONTENT
           ================================================================ */
        .main-content {
            flex: 1;
            min-width: 0;
            padding: 2rem;
        }

        /* ================================================================
           LOADING STATE
           ================================================================ */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1.25rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container p {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }

        .loading-error {
            color: var(--color-error);
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* ================================================================
           SEARCH
           ================================================================ */
        .search-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
            font-size: 0.95rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.75rem;
            font-size: 0.95rem;
            font-family: Georgia, 'Times New Roman', Times, serif;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-card);
            color: var(--color-text);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
        }

        .search-input::placeholder {
            color: var(--color-text-muted);
        }

        .search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            line-height: 1;
            display: none;
        }

        .search-clear:hover {
            color: var(--color-text);
        }

        /* Search snippet (body-text match excerpt) */
        .article-card-snippet {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: 0.35rem;
            line-height: 1.5;
            font-style: italic;
        }

        .search-highlight {
            background: #fef08a;
            color: var(--color-text);
            font-weight: 600;
            font-style: normal;
            padding: 0.05rem 0.15rem;
            border-radius: 2px;
        }

        .search-highlight.current {
            background: #f59e0b;
            outline: 2px solid #d97706;
        }

        .highlight-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            background: #fef9e7;
            border: 1px solid #f9e79f;
            border-radius: var(--radius-md);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.82rem;
            color: var(--color-text-secondary);
        }

        .highlight-nav-info { flex: 1; }

        .highlight-nav-btn {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 0.2rem 0.6rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        .highlight-nav-btn:hover { background: var(--color-bg); }

        .highlight-nav-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-muted);
            font-size: 1rem;
            padding: 0.1rem 0.3rem;
        }

        .search-loading-indicator {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-align: center;
            padding: 0.5rem 0;
            display: none;
        }

        /* Date range filter */
        .date-range-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1.25rem;
        }

        .date-range-row label {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            min-width: 2.5rem;
        }

        .date-range-row select {
            flex: 1;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.8rem;
            padding: 0.3rem 0.4rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-card);
            color: var(--color-text);
            cursor: pointer;
        }

        .date-range-row select:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        .date-range-clear {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.2rem 1.25rem;
            display: none;
        }

        .date-range-clear:hover {
            color: var(--color-error);
        }

        /* ================================================================
           RESULTS SUMMARY
           ================================================================ */
        .results-summary {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .results-summary .active-filter {
            background: var(--color-blue-light);
            color: var(--color-blue-hover);
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        .results-summary .clear-filter {
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--color-text-muted);
            margin-left: 0.5rem;
        }

        .results-summary .clear-filter:hover {
            color: var(--color-error);
        }

        /* ================================================================
           ARTICLE CARDS (LIST VIEW)
           ================================================================ */
        .article-list {
            list-style: none;
        }

        .article-card {
            background: var(--color-card);
            border-radius: var(--radius-md);
            padding: 1.25rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: box-shadow var(--transition-normal), transform var(--transition-normal);
            border: 1px solid var(--color-border-light);
        }

        .article-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .article-card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--color-navy);
            margin-bottom: 0.35rem;
            line-height: 1.35;
        }

        .article-card-meta {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
        }

        .article-card-meta .sep {
            margin: 0 0.4rem;
            color: var(--color-text-muted);
        }

        .article-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        /* ================================================================
           TAGS
           ================================================================ */
        .tag {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            display: inline-block;
        }

        .tag-principle {
            background: var(--color-tag-principle-bg);
            color: var(--color-tag-principle-text);
        }

        .tag-application {
            background: var(--color-tag-application-bg);
            color: var(--color-tag-application-text);
        }

        .tag-keyword {
            background: var(--color-tag-keyword-bg);
            color: var(--color-tag-keyword-text);
        }

        .tag-clickable {
            cursor: pointer;
            transition: opacity var(--transition-fast);
        }

        .tag-clickable:hover {
            opacity: 0.8;
        }

        /* ================================================================
           NO RESULTS
           ================================================================ */
        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--color-text-secondary);
        }

        .no-results h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        .no-results p {
            font-size: 0.9rem;
        }

        /* ================================================================
           PAGINATION
           ================================================================ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1.75rem 0 0.5rem;
        }

        .pagination-btn {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--color-blue);
            color: #ffffff;
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--color-blue-hover);
        }

        .pagination-btn:disabled {
            background: var(--color-border);
            color: var(--color-text-muted);
            cursor: default;
        }

        .pagination-info {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        /* ================================================================
           ARTICLE DETAIL VIEW
           ================================================================ */
        .article-detail {
            display: none;
        }

        .article-detail.active {
            display: block;
        }

        .back-btn {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 1.25rem;
            color: var(--color-blue);
            cursor: pointer;
            font-size: 0.9rem;
            background: none;
            border: none;
            padding: 0.35rem 0;
            font-weight: 500;
        }

        .back-btn:hover {
            color: var(--color-blue-hover);
            text-decoration: underline;
        }

        .article-detail-header {
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .article-detail-header h1 {
            font-size: 1.75rem;
            color: var(--color-navy);
            margin-bottom: 0.5rem;
            line-height: 1.25;
        }

        .article-detail-meta {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.75rem;
        }

        .article-detail-meta .reprint-note {
            font-style: italic;
            color: var(--color-text-muted);
        }

        .article-detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .article-detail-tags .tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
        }

        /* Article body content */
        .article-body {
            background: var(--color-card);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border-light);
        }

        .article-body h1 {
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            color: var(--color-navy);
        }

        .article-body h2 {
            font-size: 1.25rem;
            margin: 1.75rem 0 0.75rem;
            color: var(--color-navy);
        }

        .article-body h3 {
            font-size: 1.1rem;
            margin: 1.5rem 0 0.5rem;
            color: var(--color-navy);
        }

        .article-body p {
            margin-bottom: 1rem;
            text-align: justify;
            text-justify: inter-word;
            hyphens: auto;
            -webkit-hyphens: auto;
        }

        .article-body blockquote {
            border-left: 3px solid var(--color-blue);
            padding: 0.75rem 1.25rem;
            margin: 1.25rem 0;
            background: var(--color-bg);
            color: var(--color-text-secondary);
            font-style: italic;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .article-body blockquote p:last-child {
            margin-bottom: 0;
        }

        .article-body em {
            font-style: italic;
        }

        .article-body strong {
            font-weight: 700;
        }

        .article-body hr {
            margin: 2rem 0;
            border: none;
            border-top: 1px solid var(--color-border);
        }

        .article-body ul, .article-body ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .article-body li {
            margin-bottom: 0.4rem;
        }

        .article-body .smallcaps {
            font-variant: small-caps;
        }

        /* Keywords section at bottom of article */
        .article-keywords {
            margin-top: 2rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--color-border);
        }

        .article-keywords-label {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
        }

        .article-keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        /* ================================================================
           ARTICLE LOADING
           ================================================================ */
        .article-loading {
            text-align: center;
            padding: 3rem;
            color: var(--color-text-secondary);
        }

        .article-loading .spinner {
            margin: 0 auto 1rem;
        }

        /* ================================================================
           FOOTER
           ================================================================ */
        .site-footer {
            text-align: center;
            padding: 2rem;
            color: var(--color-text-muted);
            font-size: 0.8rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            border-top: 1px solid var(--color-border-light);
            margin-top: 2rem;
        }

        /* ================================================================
           NOSCRIPT
           ================================================================ */
        .noscript-message {
            max-width: 600px;
            margin: 4rem auto;
            padding: 2rem;
            text-align: center;
            background: var(--color-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .noscript-message h2 {
            margin-bottom: 1rem;
            color: var(--color-navy);
        }

        .noscript-message p {
            color: var(--color-text-secondary);
        }

        /* ================================================================
           SEARCH PANEL (right column)
           ================================================================ */
        .search-panel {
            width: 380px;
            min-width: 380px;
            background: var(--color-card);
            border-left: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .search-panel-inner {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .search-panel-header {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-panel-close {
            display: none;
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.15rem 0.35rem;
            line-height: 1;
            border-radius: var(--radius-sm);
        }

        .search-panel-close:hover {
            color: var(--color-text);
            background: var(--color-bg);
        }

        .search-panel-input-wrap {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .search-panel-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
            font-size: 0.85rem;
        }

        .search-panel-input {
            width: 100%;
            padding: 0.6rem 2rem 0.6rem 2.25rem;
            font-size: 0.875rem;
            font-family: Georgia, 'Times New Roman', Times, serif;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg);
            color: var(--color-text);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            outline: none;
        }

        .search-panel-input:focus {
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
            background: var(--color-card);
        }

        .search-panel-input::placeholder {
            color: var(--color-text-muted);
        }

        .search-panel-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.15rem;
            line-height: 1;
            display: none;
        }

        .search-panel-clear:hover {
            color: var(--color-text);
        }

        .search-panel-count {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.78rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.6rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border-light);
        }

        .search-panel-modes {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 0.6rem;
        }

        .search-mode-pill {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.7rem;
            padding: 0.25rem 0.6rem;
            border: 1px solid var(--color-border);
            border-radius: 999px;
            background: var(--color-bg);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .search-mode-pill.active {
            background: var(--color-blue);
            color: #ffffff;
            border-color: var(--color-blue);
        }

        .search-mode-pill:hover:not(.active) {
            background: var(--color-border-light);
        }

        .search-fields {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.15rem 0.6rem;
            margin-bottom: 0.6rem;
            font-size: 0.72rem;
            color: var(--color-text-secondary);
        }

        .search-fields-label {
            font-weight: 600;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
        }

        .search-fields label {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            user-select: none;
        }

        .search-fields input[type="checkbox"] {
            margin: 0;
            accent-color: var(--color-blue);
        }

        .search-tips {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.72rem;
            color: var(--color-text-muted);
            margin-bottom: 0.6rem;
        }

        .search-tips summary { cursor: pointer; user-select: none; }

        .search-tips ul {
            margin-top: 0.35rem;
            padding-left: 1.2rem;
            line-height: 1.7;
        }

        .search-tips code {
            background: var(--color-bg);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .search-panel-results {
            flex: 1;
            overflow-y: auto;
            margin: 0 -1.25rem;
            padding: 0 1.25rem;
        }

        .search-panel-card {
            padding: 0.65rem 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--color-border-light);
        }

        .search-panel-card:hover {
            background: var(--color-bg);
        }

        .search-panel-card.active {
            background: var(--color-blue-light);
            border-left: 3px solid var(--color-blue);
            padding-left: calc(0.75rem - 3px);
        }

        .search-panel-card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-navy);
            line-height: 1.3;
            margin-bottom: 0.15rem;
        }

        .search-panel-card-meta {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 0.72rem;
            color: var(--color-text-muted);
        }

        .search-panel-card-snippet {
            font-size: 0.78rem;
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
            line-height: 1.4;
            font-style: italic;
        }

        .search-panel-empty {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--color-text-muted);
        }

        .search-panel-empty-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            opacity: 0.4;
        }

        .search-panel-empty p {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .search-panel-empty .panel-article-count {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        /* Search toggle button for tablet/mobile */
        .search-toggle-btn {
            display: none;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            line-height: 1;
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
            margin-right: 0.5rem;
        }

        .search-toggle-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Search panel overlay for tablet/mobile */
        .search-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 55;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .search-panel-overlay.visible {
            opacity: 1;
        }

        /* ================================================================
           RESPONSIVE: SEARCH PANEL BREAKPOINT
           ================================================================ */
        @media (max-width: 1200px) {
            .search-panel {
                position: fixed;
                top: 0;
                right: 0;
                height: 100vh;
                z-index: 60;
                transform: translateX(100%);
                transition: transform var(--transition-normal);
                box-shadow: none;
            }

            .search-panel.open {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .search-panel-overlay {
                display: block;
            }

            .search-toggle-btn {
                display: block;
            }

            .search-panel-close {
                display: block;
            }
        }

        /* ================================================================
           RESPONSIVE: TABLET
           ================================================================ */
        @media (max-width: 1024px) {
            .main-content {
                padding: 1.5rem;
            }

            .article-body {
                padding: 1.75rem;
            }
        }

        /* ================================================================
           RESPONSIVE: MOBILE
           ================================================================ */
        @media (max-width: 768px) {
            .hamburger-btn {
                display: block;
            }

            .search-toggle-btn {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
                box-shadow: none;
            }

            .sidebar.open {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .sidebar-overlay {
                display: block;
            }

            .search-panel {
                width: 100%;
                min-width: 100%;
            }

            .site-header h1 {
                font-size: 1.15rem;
            }

            .site-header .subtitle {
                display: none;
            }

            .main-content {
                padding: 1rem;
            }

            .article-body {
                padding: 1.25rem;
            }

            .article-detail-header h1 {
                font-size: 1.35rem;
            }

            .article-card {
                padding: 1rem 1.15rem;
            }
        }

        /* ================================================================
           PRINT STYLES
           ================================================================ */
        @media print {
            .sidebar,
            .sidebar-overlay,
            .hamburger-btn,
            .search-toggle-btn,
            .search-panel,
            .search-panel-overlay,
            .search-wrapper,
            .pagination,
            .back-btn,
            .results-summary,
            .highlight-nav,
            .site-header .back-link {
                display: none !important;
            }

            .search-highlight {
                background: none !important;
                font-weight: inherit !important;
                padding: 0 !important;
                outline: none !important;
            }

            .site-header {
                background: none;
                color: var(--color-text);
                box-shadow: none;
                padding: 1rem 0;
                border-bottom: 2px solid #000;
            }

            .app-layout {
                display: block;
            }

            .main-content {
                max-width: 100%;
                padding: 0;
            }

            .article-body {
                box-shadow: none;
                border: none;
                padding: 0;
            }

            .article-card {
                box-shadow: none;
                border: 1px solid #ccc;
                break-inside: avoid;
            }
        }

        /* ================================================================
           ACCESSIBILITY
           ================================================================ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        :focus-visible {
            outline: 2px solid var(--color-blue);
            outline-offset: 2px;
        }

        .sidebar-link:focus-visible,
        .article-card:focus-visible {
            outline: 2px solid var(--color-blue);
            outline-offset: -2px;
        }
    </style>
</head>
<body>
    <!-- No-JavaScript fallback -->
    <noscript>
        <div class="noscript-message">
            <h2>JavaScript Required</h2>
            <p>The American Sentinel Research Archive requires JavaScript to browse and search the article catalog. Please enable JavaScript in your browser settings and reload this page.</p>
        </div>
    </noscript>

    <div class="app-root">
        <!-- ============================================================
             HEADER
             ============================================================ -->
        <header class="site-header" role="banner">
            <div class="site-header-inner">
                <div>
                    <a href="https://americansentinel.org" class="back-link">&larr; americansentinel.org</a>
                    <h1>American Sentinel Research Archive</h1>
                    <p class="subtitle">Historical writings on religious liberty and church-state separation, 1886&ndash;1900</p>
                </div>
                <div style="display:flex;align-items:center;">
                    <button class="search-toggle-btn" id="search-toggle-btn" aria-label="Toggle search panel">&#128269;</button>
                    <button class="hamburger-btn" id="hamburger-btn" aria-label="Toggle navigation menu" aria-expanded="false">&#9776;</button>
                </div>
            </div>
        </header>

        <!-- ============================================================
             APP LAYOUT
             ============================================================ -->
        <div class="app-layout">
            <!-- Sidebar overlay for mobile -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- Sidebar navigation -->
            <nav class="sidebar" id="sidebar" role="navigation" aria-label="Article filters">
                <div class="sidebar-inner">
                    <!-- Browse section -->
                    <div class="sidebar-section">
                        <div class="sidebar-heading">Browse</div>
                        <ul class="sidebar-list">
                            <li>
                                <a class="sidebar-link active" id="nav-all" data-route="" role="button" tabindex="0">
                                    <span class="label">All Articles</span>
                                    <span class="count" id="total-count">&hellip;</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <hr class="sidebar-divider">

                    <!-- Date Range Filter -->
                    <div class="sidebar-section">
                        <div class="sidebar-heading">Date Range</div>
                        <div class="date-range-row">
                            <label for="year-from">From</label>
                            <select id="year-from"><option value="">All</option></select>
                        </div>
                        <div class="date-range-row">
                            <label for="year-to">To</label>
                            <select id="year-to"><option value="">All</option></select>
                        </div>
                        <a class="date-range-clear" id="date-range-clear" role="button" tabindex="0">Clear date range</a>
                    </div>

                    <hr class="sidebar-divider">

                    <!-- Years -->
                    <div class="sidebar-section">
                        <div class="sidebar-heading">Years</div>
                        <ul class="sidebar-list" id="years-nav"></ul>
                    </div>

                    <hr class="sidebar-divider">

                    <!-- Principles -->
                    <div class="sidebar-section">
                        <div class="sidebar-heading">Principles</div>
                        <ul class="sidebar-list" id="principles-nav"></ul>
                    </div>

                    <hr class="sidebar-divider">

                    <!-- Authors -->
                    <div class="sidebar-section">
                        <div class="sidebar-heading">Authors</div>
                        <ul class="sidebar-list" id="authors-nav"></ul>
                    </div>
                </div>
            </nav>

            <!-- Main content area -->
            <main class="main-content" id="main-content" role="main">
                <!-- Loading state -->
                <div class="loading-container" id="loading-state">
                    <div class="spinner"></div>
                    <p>Loading article catalog&hellip;</p>
                </div>

                <!-- List view (search + cards + pagination) -->
                <div id="list-view" style="display:none">
                    <div class="search-wrapper">
                        <span class="search-icon" aria-hidden="true">&#128269;</span>
                        <input type="search"
                               class="search-input"
                               id="search-input"
                               placeholder="Search articles by title, author, keyword&hellip;"
                               aria-label="Search articles">
                        <button class="search-clear" id="search-clear" aria-label="Clear search">&times;</button>
                    </div>

                    <div class="search-loading-indicator" id="search-loading">Loading full-text search index&hellip;</div>

                    <div class="results-summary" id="results-summary"></div>

                    <ul class="article-list" id="article-list" role="list"></ul>

                    <div class="pagination" id="pagination" style="display:none">
                        <button class="pagination-btn" id="prev-btn" aria-label="Previous page">&larr; Previous</button>
                        <span class="pagination-info" id="page-info"></span>
                        <button class="pagination-btn" id="next-btn" aria-label="Next page">Next &rarr;</button>
                    </div>
                </div>

                <!-- Article detail view -->
                <div class="article-detail" id="article-detail">
                    <button class="back-btn" id="detail-back-btn">&larr; Back to list</button>

                    <div class="article-detail-header">
                        <h1 id="detail-title"></h1>
                        <div class="article-detail-meta" id="detail-meta"></div>
                        <div class="article-detail-tags" id="detail-tags"></div>
                    </div>

                    <div class="highlight-nav" id="highlight-nav" style="display:none">
                        <span class="highlight-nav-info" id="highlight-nav-info"></span>
                        <button class="highlight-nav-btn" id="highlight-prev">&uarr; Prev</button>
                        <button class="highlight-nav-btn" id="highlight-next">&darr; Next</button>
                        <button class="highlight-nav-close" id="highlight-close" aria-label="Clear highlights">&times;</button>
                    </div>

                    <div class="article-body" id="detail-body">
                        <div class="article-loading">
                            <div class="spinner"></div>
                            <p>Loading article&hellip;</p>
                        </div>
                    </div>

                    <div class="article-keywords" id="detail-keywords" style="display:none">
                        <div class="article-keywords-label">Keywords</div>
                        <div class="article-keywords-list" id="detail-keywords-list"></div>
                    </div>
                </div>
            </main>

            <!-- Search panel overlay for tablet/mobile -->
            <div class="search-panel-overlay" id="search-panel-overlay"></div>

            <!-- Search panel (right column) -->
            <aside class="search-panel" id="search-panel" role="search" aria-label="Full-text search">
                <div class="search-panel-inner">
                    <div class="search-panel-header">
                        <span>Search Articles</span>
                        <button class="search-panel-close" id="search-panel-close" aria-label="Close search panel">&times;</button>
                    </div>

                    <div class="search-panel-input-wrap">
                        <span class="search-panel-icon" aria-hidden="true">&#128269;</span>
                        <input type="search"
                               class="search-panel-input"
                               id="panel-search-input"
                               placeholder="Search full text&hellip;"
                               aria-label="Search across all articles">
                        <button class="search-panel-clear" id="panel-search-clear" aria-label="Clear search">&times;</button>
                    </div>

                    <div class="search-panel-modes" id="search-panel-modes">
                        <button class="search-mode-pill active" data-mode="and">All Words</button>
                        <button class="search-mode-pill" data-mode="phrase">Exact Phrase</button>
                        <button class="search-mode-pill" data-mode="or">Any Word</button>
                    </div>
                    <details class="search-tips">
                        <summary>Search tips</summary>
                        <ul>
                            <li>Use <code>"quotes"</code> for exact phrases</li>
                            <li>Use <code>-word</code> to exclude a term</li>
                            <li>Use <code>*</code> for wildcards: <code>legislat*</code></li>
                            <li>Use <code>"word1 word2"~5</code> for proximity</li>
                            <li>Prefix with <code>title:</code> or <code>author:</code></li>
                        </ul>
                    </details>
                    <div class="search-fields" id="search-fields">
                        <span class="search-fields-label">Search in:</span>
                        <label><input type="checkbox" value="title" checked> Title</label>
                        <label><input type="checkbox" value="author" checked> Author</label>
                        <label><input type="checkbox" value="keywords" checked> Keywords</label>
                        <label><input type="checkbox" value="categories" checked> Categories</label>
                        <label><input type="checkbox" value="body" checked> Body</label>
                    </div>

                    <div class="search-panel-count" id="panel-search-count" style="display:none"></div>

                    <div class="search-panel-results" id="panel-search-results">
                        <div class="search-panel-empty" id="panel-search-empty">
                            <div class="search-panel-empty-icon">&#128269;</div>
                            <p>Search across <span class="panel-article-count" id="panel-article-count">&hellip;</span> articles by title, author, or full text.</p>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
            American Sentinel Research Archive &mdash; Preserving the words of Adventist pioneers on religious liberty
        </footer>
    </div>

    <!-- ================================================================
         JAVASCRIPT APPLICATION
         ================================================================ -->
    <script>
    (function() {
        'use strict';

        /* ============================================================
           CONFIGURATION
           ============================================================ */
        var CATALOG_URL = '{CATALOG_URL}';
        var ARTICLES_BASE = 'articles/';
        var SEARCH_DATA_URL = 'search-data.json';
        var PAGE_SIZE = 25;

        /* ============================================================
           STATE
           ============================================================ */
        var catalog = null;
        var filteredArticles = [];
        var currentPage = 0;
        var previousHash = '';

        // Index for fast lookups
        var articleById = {};

        // Full-text search data (lazy-loaded)
        var searchData = null;         // Map: article_id -> plain text
        var searchDataLoading = false;
        var searchDataLoaded = false;

        // Active filter state (compound)
        var activeFilter = {
            type: null,       // 'year', 'principle', 'application', 'author', or null
            value: null,
            search: '',       // search query text
            yearFrom: '',     // date range
            yearTo: ''
        };

        // Current search query for snippet highlighting
        var currentSearchQuery = '';

        // Search panel state (independent of sidebar filters)
        var panelSearchQuery = '';
        var panelFilteredArticles = [];
        var currentArticleId = null;

        // Advanced search state
        var currentSearchMode = 'and';   // 'and', 'phrase', 'or'
        var panelMatchedTerms = [];
        var searchFields = { title: true, author: true, keywords: true, categories: true, body: true };

        // Highlight navigation state
        var highlightMatches = [];
        var currentHighlightIndex = -1;

        /* ============================================================
           DOM REFERENCES (cached after DOMContentLoaded)
           ============================================================ */
        var dom = {};

        function cacheDom() {
            dom.loadingState = document.getElementById('loading-state');
            dom.listView = document.getElementById('list-view');
            dom.articleDetail = document.getElementById('article-detail');
            dom.searchInput = document.getElementById('search-input');
            dom.searchClear = document.getElementById('search-clear');
            dom.searchLoading = document.getElementById('search-loading');
            dom.resultsSummary = document.getElementById('results-summary');
            dom.articleList = document.getElementById('article-list');
            dom.pagination = document.getElementById('pagination');
            dom.prevBtn = document.getElementById('prev-btn');
            dom.nextBtn = document.getElementById('next-btn');
            dom.pageInfo = document.getElementById('page-info');
            dom.totalCount = document.getElementById('total-count');
            dom.yearsNav = document.getElementById('years-nav');
            dom.principlesNav = document.getElementById('principles-nav');
            dom.authorsNav = document.getElementById('authors-nav');
            dom.detailTitle = document.getElementById('detail-title');
            dom.detailMeta = document.getElementById('detail-meta');
            dom.detailTags = document.getElementById('detail-tags');
            dom.detailBody = document.getElementById('detail-body');
            dom.detailKeywords = document.getElementById('detail-keywords');
            dom.detailKeywordsList = document.getElementById('detail-keywords-list');
            dom.detailBackBtn = document.getElementById('detail-back-btn');
            dom.sidebar = document.getElementById('sidebar');
            dom.sidebarOverlay = document.getElementById('sidebar-overlay');
            dom.hamburgerBtn = document.getElementById('hamburger-btn');
            dom.navAll = document.getElementById('nav-all');
            dom.yearFrom = document.getElementById('year-from');
            dom.yearTo = document.getElementById('year-to');
            dom.dateRangeClear = document.getElementById('date-range-clear');

            // Search mode pills and field filters
            dom.searchPanelModes = document.getElementById('search-panel-modes');
            dom.searchFields = document.getElementById('search-fields');

            // Highlight navigation
            dom.highlightNav = document.getElementById('highlight-nav');
            dom.highlightNavInfo = document.getElementById('highlight-nav-info');
            dom.highlightPrev = document.getElementById('highlight-prev');
            dom.highlightNext = document.getElementById('highlight-next');
            dom.highlightClose = document.getElementById('highlight-close');

            // Search panel
            dom.searchPanel = document.getElementById('search-panel');
            dom.searchPanelOverlay = document.getElementById('search-panel-overlay');
            dom.searchPanelClose = document.getElementById('search-panel-close');
            dom.searchToggleBtn = document.getElementById('search-toggle-btn');
            dom.panelSearchInput = document.getElementById('panel-search-input');
            dom.panelSearchClear = document.getElementById('panel-search-clear');
            dom.panelSearchCount = document.getElementById('panel-search-count');
            dom.panelSearchResults = document.getElementById('panel-search-results');
            dom.panelSearchEmpty = document.getElementById('panel-search-empty');
            dom.panelArticleCount = document.getElementById('panel-article-count');
        }

        /* ============================================================
           UTILITY FUNCTIONS
           ============================================================ */
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeHtml(str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function encodeHashParam(str) {
            return encodeURIComponent(str).replace(/%20/g, '+');
        }

        function decodeHashParam(str) {
            return decodeURIComponent(str.replace(/\+/g, ' '));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            var parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            var months = ['January','February','March','April','May','June',
                          'July','August','September','October','November','December'];
            var monthIdx = parseInt(parts[1], 10) - 1;
            var day = parseInt(parts[2], 10);
            var year = parts[0];
            if (monthIdx < 0 || monthIdx > 11) return dateStr;
            return months[monthIdx] + ' ' + day + ', ' + year;
        }

        function cssEscape(str) {
            if (window.CSS && window.CSS.escape) return window.CSS.escape(str);
            return str.replace(/([^\w-])/g, '\\$1');
        }

        /* ============================================================
           DATA LOADING
           ============================================================ */
        function loadCatalog() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', CATALOG_URL, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState !== 4) return;
                if (xhr.status === 200) {
                    try {
                        catalog = JSON.parse(xhr.responseText);
                        onCatalogLoaded();
                    } catch (e) {
                        showLoadError('Failed to parse catalog data: ' + e.message);
                    }
                } else {
                    showLoadError('Failed to load catalog (HTTP ' + xhr.status + '). Please try refreshing the page.');
                }
            };
            xhr.onerror = function() {
                showLoadError('Network error loading catalog. Please check your connection and try again.');
            };
            xhr.send();
        }

        function showLoadError(message) {
            dom.loadingState.innerHTML =
                '<div class="loading-error"><strong>Error:</strong> ' + escapeHtml(message) + '</div>';
        }

        function loadSearchData(callback) {
            if (searchDataLoaded) {
                if (callback) callback();
                return;
            }
            if (searchDataLoading) return;
            searchDataLoading = true;
            dom.searchLoading.style.display = 'block';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', SEARCH_DATA_URL, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState !== 4) return;
                searchDataLoading = false;
                dom.searchLoading.style.display = 'none';
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        searchData = {};
                        for (var i = 0; i < data.length; i++) {
                            searchData[data[i].id] = data[i].t;
                        }
                        searchDataLoaded = true;
                        if (callback) callback();
                    } catch (e) {
                        // Silently fail  metadata search still works
                    }
                }
            };
            xhr.onerror = function() {
                searchDataLoading = false;
                dom.searchLoading.style.display = 'none';
            };
            xhr.send();
        }

        function onCatalogLoaded() {
            // Build index
            articleById = {};
            for (var i = 0; i < catalog.articles.length; i++) {
                var a = catalog.articles[i];
                articleById[a.id] = a;
            }

            // Set total count
            dom.totalCount.textContent = catalog.article_count;
            dom.panelArticleCount.textContent = catalog.article_count;

            // Build sidebar navigation
            renderYearsNav();
            renderDateRangeDropdowns();
            renderPrinciplesNav();
            renderAuthorsNav();

            // Hide loading, show list
            dom.loadingState.style.display = 'none';
            dom.listView.style.display = 'block';

            // Handle initial route
            handleRoute();

            // Eagerly load full-text search data in background
            loadSearchData(null);
        }

        /* ============================================================
           SIDEBAR RENDERING
           ============================================================ */
        function renderYearsNav() {
            var yearCounts = {};
            for (var i = 0; i < catalog.articles.length; i++) {
                var d = catalog.articles[i].date;
                if (d) {
                    var year = d.substring(0, 4);
                    yearCounts[year] = (yearCounts[year] || 0) + 1;
                }
            }

            var years = Object.keys(yearCounts).sort();
            var html = '';
            for (var j = 0; j < years.length; j++) {
                var y = years[j];
                html += '<li><a class="sidebar-link" data-route="year/' + y + '" role="button" tabindex="0">' +
                    '<span class="label">' + y + '</span>' +
                    '<span class="count">' + yearCounts[y] + '</span></a></li>';
            }
            dom.yearsNav.innerHTML = html;
        }

        function renderDateRangeDropdowns() {
            var years = [];
            var seen = {};
            for (var i = 0; i < catalog.articles.length; i++) {
                var d = catalog.articles[i].date;
                if (d) {
                    var y = d.substring(0, 4);
                    if (!seen[y]) {
                        seen[y] = true;
                        years.push(y);
                    }
                }
            }
            years.sort();

            var fromHtml = '<option value="">All</option>';
            var toHtml = '<option value="">All</option>';
            for (var j = 0; j < years.length; j++) {
                fromHtml += '<option value="' + years[j] + '">' + years[j] + '</option>';
                toHtml += '<option value="' + years[j] + '">' + years[j] + '</option>';
            }
            dom.yearFrom.innerHTML = fromHtml;
            dom.yearTo.innerHTML = toHtml;
        }

        function renderPrinciplesNav() {
            var principleCounts = {};
            var appCounts = {};

            for (var i = 0; i < catalog.articles.length; i++) {
                var a = catalog.articles[i];
                var ps = a.principles || [];
                for (var p = 0; p < ps.length; p++) {
                    principleCounts[ps[p]] = (principleCounts[ps[p]] || 0) + 1;
                }
                var apps = a.applications || [];
                for (var ap = 0; ap < apps.length; ap++) {
                    appCounts[apps[ap]] = (appCounts[apps[ap]] || 0) + 1;
                }
            }

            var principles = catalog.taxonomy.principles || [];
            var appsByPrinciple = catalog.taxonomy.applications || {};
            var html = '';

            for (var pi = 0; pi < principles.length; pi++) {
                var principle = principles[pi];
                var count = principleCounts[principle] || 0;
                if (count === 0) continue;

                var subApps = appsByPrinciple[principle] || [];
                var activeApps = [];
                for (var sa = 0; sa < subApps.length; sa++) {
                    if (appCounts[subApps[sa]]) {
                        activeApps.push(subApps[sa]);
                    }
                }

                var hasChildren = activeApps.length > 0;
                var arrowHtml = hasChildren
                    ? '<span class="expand-icon" id="arrow-' + cssEscape(principle) + '">&#9654;</span>'
                    : '';

                html += '<li>';
                html += '<a class="sidebar-link" data-route="principle/' + encodeHashParam(principle) + '" role="button" tabindex="0">' +
                    arrowHtml +
                    '<span class="label">' + escapeHtml(principle) + '</span>' +
                    '<span class="count">' + count + '</span></a>';

                if (hasChildren) {
                    html += '<ul class="sub-list" id="sub-' + cssEscape(principle) + '">';
                    for (var ai = 0; ai < activeApps.length; ai++) {
                        var app = activeApps[ai];
                        html += '<li><a class="sidebar-link" data-route="application/' + encodeHashParam(app) + '" role="button" tabindex="0">' +
                            '<span class="label">' + escapeHtml(app) + '</span>' +
                            '<span class="count">' + (appCounts[app] || 0) + '</span></a></li>';
                    }
                    html += '</ul>';
                }
                html += '</li>';
            }

            dom.principlesNav.innerHTML = html;
        }

        function renderAuthorsNav() {
            var authorCounts = {};
            for (var i = 0; i < catalog.articles.length; i++) {
                var author = catalog.articles[i].author || null;
                if (author) {
                    authorCounts[author] = (authorCounts[author] || 0) + 1;
                }
            }

            var authors = Object.keys(authorCounts).sort();
            var html = '';
            for (var j = 0; j < authors.length; j++) {
                var a = authors[j];
                html += '<li><a class="sidebar-link" data-route="author/' + encodeHashParam(a) + '" role="button" tabindex="0">' +
                    '<span class="label">' + escapeHtml(a) + '</span>' +
                    '<span class="count">' + authorCounts[a] + '</span></a></li>';
            }
            dom.authorsNav.innerHTML = html;
        }

        /* ============================================================
           SIDEBAR INTERACTIONS
           ============================================================ */
        function setActiveNav(route) {
            var links = document.querySelectorAll('.sidebar-link');
            for (var i = 0; i < links.length; i++) {
                links[i].classList.remove('active');
            }

            if (route === '' || route === undefined) {
                dom.navAll.classList.add('active');
                return;
            }

            for (var j = 0; j < links.length; j++) {
                if (links[j].getAttribute('data-route') === route) {
                    links[j].classList.add('active');
                    break;
                }
            }
        }

        function expandPrincipleGroup(principle) {
            var allSubs = document.querySelectorAll('.sub-list');
            var allArrows = document.querySelectorAll('.expand-icon');
            for (var i = 0; i < allSubs.length; i++) {
                allSubs[i].classList.remove('open');
            }
            for (var j = 0; j < allArrows.length; j++) {
                allArrows[j].classList.remove('open');
            }

            var subList = document.getElementById('sub-' + cssEscape(principle));
            var arrow = document.getElementById('arrow-' + cssEscape(principle));
            if (subList) subList.classList.add('open');
            if (arrow) arrow.classList.add('open');
        }

        function expandPrincipleGroupForApplication(appName) {
            var appsByPrinciple = catalog.taxonomy.applications || {};
            var principles = Object.keys(appsByPrinciple);
            for (var i = 0; i < principles.length; i++) {
                var apps = appsByPrinciple[principles[i]];
                for (var j = 0; j < apps.length; j++) {
                    if (apps[j] === appName) {
                        expandPrincipleGroup(principles[i]);
                        return;
                    }
                }
            }
        }

        /* Mobile sidebar */
        function openSidebar() {
            dom.sidebar.classList.add('open');
            dom.sidebarOverlay.style.display = 'block';
            dom.sidebarOverlay.offsetHeight;
            dom.sidebarOverlay.classList.add('visible');
            dom.hamburgerBtn.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            dom.sidebar.classList.remove('open');
            dom.sidebarOverlay.classList.remove('visible');
            dom.hamburgerBtn.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
            setTimeout(function() {
                if (!dom.sidebarOverlay.classList.contains('visible')) {
                    dom.sidebarOverlay.style.display = 'none';
                }
            }, 300);
        }

        /* ============================================================
           COMPOUND FILTERING
           ============================================================ */
        function applyFilters() {
            var articles = catalog.articles;

            // 1. Apply sidebar filter (type/value)
            if (activeFilter.type === 'year') {
                articles = articles.filter(function(a) {
                    return a.date && a.date.substring(0, 4) === activeFilter.value;
                });
            } else if (activeFilter.type === 'principle') {
                articles = articles.filter(function(a) {
                    return (a.principles || []).indexOf(activeFilter.value) !== -1;
                });
            } else if (activeFilter.type === 'application') {
                articles = articles.filter(function(a) {
                    return (a.applications || []).indexOf(activeFilter.value) !== -1;
                });
            } else if (activeFilter.type === 'author') {
                articles = articles.filter(function(a) {
                    return a.author === activeFilter.value;
                });
            }

            // 2. Apply date range
            if (activeFilter.yearFrom) {
                articles = articles.filter(function(a) {
                    return a.date && a.date.substring(0, 4) >= activeFilter.yearFrom;
                });
            }
            if (activeFilter.yearTo) {
                articles = articles.filter(function(a) {
                    return a.date && a.date.substring(0, 4) <= activeFilter.yearTo;
                });
            }

            // 3. Apply search query (metadata + full-text)
            if (activeFilter.search) {
                var query = activeFilter.search.toLowerCase();
                currentSearchQuery = query;
                articles = articles.filter(function(a) {
                    // Check metadata first
                    var searchable = (a.title || '') + ' ' +
                        (a.author || '') + ' ' +
                        (a.principles || []).join(' ') + ' ' +
                        (a.applications || []).join(' ') + ' ' +
                        (a.keywords || []).join(' ');
                    if (searchable.toLowerCase().indexOf(query) !== -1) {
                        return true;
                    }
                    // Check full-text body if loaded
                    if (searchData && searchData[a.id]) {
                        return searchData[a.id].toLowerCase().indexOf(query) !== -1;
                    }
                    return false;
                });
            } else {
                currentSearchQuery = '';
            }

            return articles;
        }

        function getSearchSnippet(articleId, matchedTerms) {
            if (!searchData || !searchData[articleId] || !matchedTerms || matchedTerms.length === 0) return '';
            var text = searchData[articleId];
            var lowerText = text.toLowerCase();

            // Build regex patterns for finding and highlighting
            var patterns = [];
            for (var t = 0; t < matchedTerms.length; t++) {
                var term = matchedTerms[t];
                if (term.charAt(term.length - 1) === '*') {
                    patterns.push(escapeRegex(term.slice(0, -1)) + '\\w*');
                } else {
                    patterns.push(escapeRegex(term));
                }
            }

            // Find position of first match (for snippet centering)
            var firstIdx = -1;
            var secondIdx = -1;
            for (var t = 0; t < matchedTerms.length; t++) {
                var term = matchedTerms[t];
                var idx;
                if (term.charAt(term.length - 1) === '*') {
                    var wRe = new RegExp('\\b' + escapeRegex(term.slice(0, -1)) + '\\w*', 'i');
                    var wMatch = wRe.exec(lowerText);
                    idx = wMatch ? wMatch.index : -1;
                } else {
                    idx = lowerText.indexOf(term.toLowerCase());
                }
                if (idx !== -1) {
                    if (firstIdx === -1 || idx < firstIdx) {
                        secondIdx = firstIdx;
                        firstIdx = idx;
                    } else if (secondIdx === -1 || idx < secondIdx) {
                        secondIdx = idx;
                    }
                }
            }
            if (firstIdx === -1) return '';

            // For multi-term, try to center between first two matches
            var center = firstIdx;
            var snippetRadius = matchedTerms.length > 1 ? 100 : 75;
            if (secondIdx !== -1 && secondIdx - firstIdx < snippetRadius * 2) {
                center = Math.floor((firstIdx + secondIdx) / 2);
            }

            var start = Math.max(0, center - snippetRadius);
            var end = Math.min(text.length, center + snippetRadius);

            // Adjust to word boundaries
            if (start > 0) {
                var spaceIdx = text.indexOf(' ', start);
                if (spaceIdx !== -1 && spaceIdx < center) start = spaceIdx + 1;
            }
            if (end < text.length) {
                var spaceIdx2 = text.lastIndexOf(' ', end);
                if (spaceIdx2 > center) end = spaceIdx2;
            }

            var snippet = text.substring(start, end);
            var prefix = start > 0 ? '&hellip;' : '';
            var suffix = end < text.length ? '&hellip;' : '';

            // Highlight all matched terms in snippet (single pass to avoid tag corruption)
            var escapedSnippet = escapeHtml(snippet);
            if (patterns.length > 0) {
                var combinedRe = new RegExp('(' + patterns.join('|') + ')', 'gi');
                escapedSnippet = escapedSnippet.replace(combinedRe, '<span class="search-highlight">$1</span>');
            }

            return prefix + escapedSnippet + suffix;
        }

        function isBodyTextMatch(article, query) {
            if (!query || !searchData || !searchData[article.id]) return false;
            // Check if the match is ONLY in body text (not in metadata)
            var searchable = (article.title || '') + ' ' +
                (article.author || '') + ' ' +
                (article.principles || []).join(' ') + ' ' +
                (article.applications || []).join(' ') + ' ' +
                (article.keywords || []).join(' ');
            return searchable.toLowerCase().indexOf(query.toLowerCase()) === -1;
        }

        /* ============================================================
           RENDERING: LIST VIEW
           ============================================================ */
        function renderListView() {
            var articles = applyFilters();
            filteredArticles = articles;
            currentPage = 0;

            // Show/hide views
            dom.listView.style.display = 'block';
            dom.articleDetail.classList.remove('active');

            // Results summary
            renderResultsSummary(articles.length);

            // Render the page
            renderPage();
        }

        function renderResultsSummary(count) {
            var parts = [];

            if (activeFilter.type) {
                var typeLabel = {
                    'year': 'Year',
                    'principle': 'Principle',
                    'application': 'Application',
                    'author': 'Author'
                }[activeFilter.type] || activeFilter.type;
                parts.push(typeLabel + ': <span class="active-filter">' + escapeHtml(activeFilter.value) + '</span>');
            }

            if (activeFilter.yearFrom || activeFilter.yearTo) {
                var rangeStr = (activeFilter.yearFrom || '...') + ' &ndash; ' + (activeFilter.yearTo || '...');
                parts.push('Date: <span class="active-filter">' + rangeStr + '</span>');
            }

            if (activeFilter.search) {
                parts.push('Search: <span class="active-filter">' + escapeHtml(activeFilter.search) + '</span>');
            }

            var html = '<span>' + count + ' of ' + catalog.article_count + ' article' + (count !== catalog.article_count ? 's' : '') + '</span>';

            if (parts.length > 0) {
                html = '<span>' + count + ' article' + (count !== 1 ? 's' : '') + ' &mdash; ' +
                    parts.join(' + ') +
                    ' <a class="clear-filter" data-route="" role="button" tabindex="0">&times; Clear all</a></span>';
            }

            dom.resultsSummary.innerHTML = html;
        }

        function renderPage() {
            var articles = filteredArticles;
            var totalPages = Math.ceil(articles.length / PAGE_SIZE);
            var start = currentPage * PAGE_SIZE;
            var end = Math.min(start + PAGE_SIZE, articles.length);
            var pageArticles = articles.slice(start, end);

            if (articles.length === 0) {
                dom.articleList.innerHTML = '<li class="no-results">' +
                    '<h3>No articles found</h3>' +
                    '<p>Try adjusting your search or filters.</p></li>';
                dom.pagination.style.display = 'none';
                return;
            }

            var html = '';
            for (var i = 0; i < pageArticles.length; i++) {
                var a = pageArticles[i];
                html += renderArticleCard(a);
            }
            dom.articleList.innerHTML = html;

            // Pagination
            if (totalPages > 1) {
                dom.pagination.style.display = 'flex';
                dom.prevBtn.disabled = (currentPage === 0);
                dom.nextBtn.disabled = (currentPage >= totalPages - 1);
                dom.pageInfo.textContent = 'Page ' + (currentPage + 1) + ' of ' + totalPages +
                    ' (' + articles.length + ' articles)';
            } else {
                dom.pagination.style.display = 'none';
            }
        }

        function renderArticleCard(article) {
            var meta = [];
            if (article.author) meta.push(escapeHtml(article.author));
            if (article.date) meta.push(formatDate(article.date));
            if (article.publication) meta.push(escapeHtml(article.publication));
            if (article.volume) meta[meta.length - 1] += ', Vol.&nbsp;' + article.volume;
            if (article.issue) meta[meta.length - 1] += ', No.&nbsp;' + article.issue;

            var tags = '';
            var principles = article.principles || [];
            for (var p = 0; p < principles.length; p++) {
                tags += '<span class="tag tag-principle">' + escapeHtml(principles[p]) + '</span>';
            }
            var applications = article.applications || [];
            for (var ap = 0; ap < applications.length && ap < 3; ap++) {
                tags += '<span class="tag tag-application">' + escapeHtml(applications[ap]) + '</span>';
            }

            // Search snippet for body-text matches
            var snippetHtml = '';
            if (currentSearchQuery && searchData) {
                var snippet = getSearchSnippet(article.id, [currentSearchQuery]);
                if (snippet) {
                    snippetHtml = '<div class="article-card-snippet">' + snippet + '</div>';
                }
            }

            return '<li class="article-card" data-article-id="' + escapeHtml(article.id) + '" role="button" tabindex="0">' +
                '<div class="article-card-title">' + escapeHtml(article.title) + '</div>' +
                '<div class="article-card-meta">' + meta.join('<span class="sep">&bull;</span>') + '</div>' +
                '<div class="article-card-tags">' + tags + '</div>' +
                snippetHtml +
                '</li>';
        }

        /* ============================================================
           ADVANCED SEARCH: QUERY PARSER
           ============================================================ */
        function parseSearchQuery(queryString, defaultMode) {
            var query = queryString.trim();
            if (!query) return { mode: defaultMode || 'and', clauses: [] };

            // If "phrase" mode, wrap the entire query as one phrase
            if (defaultMode === 'phrase') {
                return {
                    mode: 'and',
                    clauses: [{ type: 'phrase', raw: query.toLowerCase(), negate: false }]
                };
            }

            // Detect explicit OR / AND operators (uppercase, word-bounded)
            var mode = defaultMode || 'and';
            var hasExplicitOr = /\bOR\b/.test(query);
            var hasExplicitAnd = /\bAND\b/.test(query);
            if (hasExplicitOr && !hasExplicitAnd) mode = 'or';

            // Remove AND/OR/NOT operators for tokenizing (NOT handled per-token)
            var cleaned = query.replace(/\bAND\b/g, ' ').replace(/\bOR\b/g, ' ');

            var clauses = [];
            var i = 0;
            var chars = cleaned;
            var len = chars.length;

            while (i < len) {
                // Skip whitespace
                while (i < len && chars[i] === ' ') i++;
                if (i >= len) break;

                var negate = false;

                // Check for NOT keyword
                if (chars.substring(i, i + 4) === 'NOT ' && i + 4 < len) {
                    negate = true;
                    i += 4;
                    while (i < len && chars[i] === ' ') i++;
                }

                // Check for - prefix (negation)
                if (!negate && chars[i] === '-' && i + 1 < len && chars[i + 1] !== ' ') {
                    negate = true;
                    i++;
                }

                // Quoted phrase: "..." or "..."~N
                if (chars[i] === '"') {
                    i++; // skip opening quote
                    var phraseEnd = chars.indexOf('"', i);
                    if (phraseEnd === -1) phraseEnd = len;
                    var phraseText = chars.substring(i, phraseEnd);
                    i = phraseEnd + 1; // skip closing quote

                    // Check for proximity: ~N
                    if (i < len && chars[i] === '~') {
                        i++; // skip ~
                        var distStr = '';
                        while (i < len && chars[i] >= '0' && chars[i] <= '9') {
                            distStr += chars[i];
                            i++;
                        }
                        var distance = parseInt(distStr, 10) || 5;
                        var proxTerms = phraseText.toLowerCase().split(/\s+/).filter(function(t) { return t; });
                        if (proxTerms.length >= 2) {
                            clauses.push({ type: 'proximity', terms: proxTerms, distance: distance, raw: phraseText.toLowerCase(), negate: negate });
                        }
                    } else {
                        // Regular phrase
                        if (phraseText.trim()) {
                            clauses.push({ type: 'phrase', raw: phraseText.toLowerCase(), negate: negate });
                        }
                    }
                    continue;
                }

                // Regular token: read until next space
                var tokenStart = i;
                while (i < len && chars[i] !== ' ') i++;
                var token = chars.substring(tokenStart, i);
                if (!token) continue;

                // Field prefix: title:word, author:word, body:word
                var colonIdx = token.indexOf(':');
                if (colonIdx > 0) {
                    var fieldName = token.substring(0, colonIdx).toLowerCase();
                    var fieldValue = token.substring(colonIdx + 1).toLowerCase();
                    if ((fieldName === 'title' || fieldName === 'author' || fieldName === 'body') && fieldValue) {
                        clauses.push({ type: 'field', field: fieldName, term: fieldValue, negate: negate });
                        continue;
                    }
                }

                // Wildcard: word*
                if (token.indexOf('*') !== -1) {
                    var prefix = token.replace(/\*/g, '').toLowerCase();
                    if (prefix.length >= 3) {
                        clauses.push({ type: 'wildcard', prefix: prefix, negate: negate });
                    } else if (prefix) {
                        // Too short for wildcard, treat as plain term
                        clauses.push({ type: 'term', term: prefix, negate: negate });
                    }
                    continue;
                }

                // Plain term  strip trailing punctuation (.,;:!?)
                var cleanToken = token.toLowerCase().replace(/[.,;:!?]+$/, '');
                if (cleanToken) {
                    clauses.push({ type: 'term', term: cleanToken, negate: negate });
                }
            }

            return { mode: mode, clauses: clauses };
        }

        /* ============================================================
           ADVANCED SEARCH: CLAUSE MATCHERS
           ============================================================ */
        var wildcardRegexCache = {};

        function matchTerm(text, term) {
            return text.indexOf(term) !== -1;
        }

        function matchPhrase(text, phrase) {
            return text.indexOf(phrase) !== -1;
        }

        function matchWildcard(text, prefix) {
            if (!wildcardRegexCache[prefix]) {
                wildcardRegexCache[prefix] = new RegExp('\\b' + escapeRegex(prefix) + '\\w*', 'i');
            }
            return wildcardRegexCache[prefix].test(text);
        }

        function matchProximity(text, terms, distance) {
            // Quick reject: all terms must exist
            for (var t = 0; t < terms.length; t++) {
                if (text.indexOf(terms[t]) === -1) return false;
            }
            // Split into words for position checking
            var words = text.match(/\S+/g) || [];
            // Find positions of each term
            var positions = [];
            for (var t = 0; t < terms.length; t++) {
                var termPositions = [];
                for (var w = 0; w < words.length; w++) {
                    if (words[w].indexOf(terms[t]) !== -1) {
                        termPositions.push(w);
                    }
                }
                if (termPositions.length === 0) return false;
                positions.push(termPositions);
            }
            // Check if all terms appear within distance of each other
            // For simplicity, check pairwise from first term's positions
            if (positions.length === 2) {
                for (var a = 0; a < positions[0].length; a++) {
                    for (var b = 0; b < positions[1].length; b++) {
                        if (Math.abs(positions[0][a] - positions[1][b]) <= distance) return true;
                    }
                }
                return false;
            }
            // For 3+ terms, check if any window of size distance contains all terms
            for (var anchor = 0; anchor < positions[0].length; anchor++) {
                var anchorPos = positions[0][anchor];
                var allClose = true;
                for (var t = 1; t < positions.length; t++) {
                    var found = false;
                    for (var p = 0; p < positions[t].length; p++) {
                        if (Math.abs(positions[t][p] - anchorPos) <= distance) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) { allClose = false; break; }
                }
                if (allClose) return true;
            }
            return false;
        }

        function testClause(clause, titleText, authorText, metaText, bodyText) {
            // Returns: { matched: boolean, fieldScore: number }
            // metaText contains keywords + categories; split for field filtering
            var sf = searchFields;

            // For explicit field: clauses, ignore the checkbox filters
            if (clause.type === 'field') {
                var fieldText = clause.field === 'title' ? titleText :
                                clause.field === 'author' ? authorText : bodyText;
                if (matchTerm(fieldText, clause.term)) return { matched: true, fieldScore: clause.field === 'title' ? 3 : clause.field === 'author' ? 2 : 1 };
                return { matched: false, fieldScore: 0 };
            }

            if (clause.type === 'proximity') {
                var parts = [];
                if (sf.title) parts.push(titleText);
                if (sf.body) parts.push(bodyText);
                var allText = parts.join(' ');
                if (allText && matchProximity(allText, clause.terms, clause.distance)) return { matched: true, fieldScore: 1 };
                return { matched: false, fieldScore: 0 };
            }

            // Generic matching for term, phrase, wildcard
            var matchFn, matchArg;
            if (clause.type === 'term') { matchFn = matchTerm; matchArg = clause.term; }
            else if (clause.type === 'phrase') { matchFn = matchPhrase; matchArg = clause.raw; }
            else if (clause.type === 'wildcard') { matchFn = matchWildcard; matchArg = clause.prefix; }
            else return { matched: false, fieldScore: 0 };

            if (sf.title && matchFn(titleText, matchArg)) return { matched: true, fieldScore: 3 };
            if (sf.author && matchFn(authorText, matchArg)) return { matched: true, fieldScore: 2 };
            if (metaText && matchFn(metaText, matchArg)) return { matched: true, fieldScore: 2 };
            if (sf.body && matchFn(bodyText, matchArg)) return { matched: true, fieldScore: 1 };
            return { matched: false, fieldScore: 0 };
        }

        function matchArticle(article, parsedQuery, bodyText) {
            var titleText = (article.title || '').toLowerCase();
            var authorText = (article.author || '').toLowerCase();
            var metaParts = [];
            if (searchFields.keywords) metaParts.push((article.keywords || []).join(' '));
            if (searchFields.categories) metaParts.push((article.principles || []).join(' ') + ' ' + (article.applications || []).join(' '));
            var metaText = metaParts.join(' ').toLowerCase();

            var clauses = parsedQuery.clauses;
            if (clauses.length === 0) return { matched: false, score: 0, matchedTerms: [] };

            var score = 0;
            var matchedTerms = [];
            var positiveMatched = 0;
            var positiveClauses = 0;

            for (var i = 0; i < clauses.length; i++) {
                var clause = clauses[i];
                var result = testClause(clause, titleText, authorText, metaText, bodyText);

                if (clause.negate) {
                    // Negated clause: if it matches, the article is excluded
                    if (result.matched) return { matched: false, score: 0, matchedTerms: [] };
                } else {
                    positiveClauses++;
                    if (result.matched) {
                        positiveMatched++;
                        score += result.fieldScore;
                        // Collect the term for highlighting
                        var highlightTerm = clause.raw || clause.term || (clause.prefix ? clause.prefix + '*' : null);
                        if (highlightTerm) matchedTerms.push(highlightTerm);
                        // For proximity, add individual terms
                        if (clause.type === 'proximity') {
                            for (var t = 0; t < clause.terms.length; t++) {
                                matchedTerms.push(clause.terms[t]);
                            }
                        }
                    }
                }
            }

            if (positiveClauses === 0) {
                // Only negation clauses  match everything not excluded
                return { matched: true, score: 1, matchedTerms: [] };
            }

            var matched = false;
            if (parsedQuery.mode === 'and') {
                matched = (positiveMatched === positiveClauses);
            } else {
                // 'or' mode
                matched = (positiveMatched > 0);
                // Bonus for matching more terms in OR mode
                score += positiveMatched - 1;
            }

            return { matched: matched, score: score, matchedTerms: matchedTerms };
        }

        /* ============================================================
           ARTICLE BODY HIGHLIGHT + NAVIGATION
           ============================================================ */
        function highlightTermInBody(matchedTerms) {
            highlightMatches = [];
            currentHighlightIndex = -1;
            if (!matchedTerms || matchedTerms.length === 0) return 0;

            // Build combined regex from all terms
            var patterns = [];
            for (var t = 0; t < matchedTerms.length; t++) {
                var term = matchedTerms[t];
                if (term.charAt(term.length - 1) === '*') {
                    patterns.push(escapeRegex(term.slice(0, -1)) + '\\w*');
                } else {
                    patterns.push(escapeRegex(term));
                }
            }
            var combinedRegex = new RegExp('(' + patterns.join('|') + ')', 'gi');

            var walker = document.createTreeWalker(
                dom.detailBody, NodeFilter.SHOW_TEXT, null, false
            );

            var textNodes = [];
            while (walker.nextNode()) textNodes.push(walker.currentNode);

            for (var i = 0; i < textNodes.length; i++) {
                var node = textNodes[i];
                var text = node.textContent;
                combinedRegex.lastIndex = 0;
                if (!combinedRegex.test(text)) continue;

                var parent = node.parentNode;
                var frag = document.createDocumentFragment();
                var lastIdx = 0;
                var match;

                combinedRegex.lastIndex = 0;
                while ((match = combinedRegex.exec(text)) !== null) {
                    if (match.index > lastIdx) {
                        frag.appendChild(document.createTextNode(text.substring(lastIdx, match.index)));
                    }
                    var span = document.createElement('span');
                    span.className = 'search-highlight';
                    span.textContent = match[0];
                    frag.appendChild(span);
                    highlightMatches.push(span);
                    lastIdx = match.index + match[0].length;
                }

                if (lastIdx < text.length) {
                    frag.appendChild(document.createTextNode(text.substring(lastIdx)));
                }
                parent.replaceChild(frag, node);
            }

            return highlightMatches.length;
        }

        function showHighlightNav(count) {
            if (count > 0) {
                dom.highlightNav.style.display = 'flex';
                dom.highlightNavInfo.textContent = 'Match 1 of ' + count;
            } else {
                dom.highlightNav.style.display = 'none';
            }
        }

        function hideHighlightNav() {
            dom.highlightNav.style.display = 'none';
        }

        function goToHighlight(index) {
            if (highlightMatches.length === 0) return;
            if (index < 0) index = highlightMatches.length - 1;
            if (index >= highlightMatches.length) index = 0;

            if (currentHighlightIndex >= 0 && currentHighlightIndex < highlightMatches.length) {
                highlightMatches[currentHighlightIndex].classList.remove('current');
            }

            currentHighlightIndex = index;
            highlightMatches[index].classList.add('current');
            highlightMatches[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            dom.highlightNavInfo.textContent = 'Match ' + (index + 1) + ' of ' + highlightMatches.length;
        }

        function nextHighlight() {
            goToHighlight(currentHighlightIndex + 1);
        }

        function prevHighlight() {
            goToHighlight(currentHighlightIndex - 1);
        }

        function clearHighlights() {
            for (var i = 0; i < highlightMatches.length; i++) {
                var span = highlightMatches[i];
                var parent = span.parentNode;
                parent.replaceChild(document.createTextNode(span.textContent), span);
                parent.normalize();
            }
            highlightMatches = [];
            currentHighlightIndex = -1;
            hideHighlightNav();
        }

        /* ============================================================
           RENDERING: ARTICLE DETAIL VIEW
           ============================================================ */
        function showArticleDetail(articleId) {
            currentArticleId = articleId;
            highlightMatches = [];
            currentHighlightIndex = -1;
            hideHighlightNav();

            var article = articleById[articleId];
            if (!article) {
                dom.detailBody.innerHTML = '<div class="no-results"><h3>Article not found</h3>' +
                    '<p>The requested article could not be located in the catalog.</p></div>';
                dom.listView.style.display = 'none';
                dom.articleDetail.classList.add('active');
                updatePanelActiveCard();
                return;
            }

            // Set header info
            dom.detailTitle.textContent = article.title || 'Untitled';

            // Meta line
            var metaParts = [];
            if (article.author) metaParts.push(escapeHtml(article.author));
            if (article.date) metaParts.push(formatDate(article.date));
            if (article.publication) {
                var pubStr = escapeHtml(article.publication);
                if (article.volume) pubStr += ', Vol.&nbsp;' + article.volume;
                if (article.issue) pubStr += ', No.&nbsp;' + article.issue;
                metaParts.push(pubStr);
            }
            var metaHtml = metaParts.join('<span class="sep"> &bull; </span>');
            if (article.original_publication) {
                metaHtml += '<br><span class="reprint-note">Reprinted from ' +
                    escapeHtml(article.original_publication) + '</span>';
            }
            dom.detailMeta.innerHTML = metaHtml;

            // Tags (clickable)
            var tagsHtml = '';
            var principles = article.principles || [];
            for (var p = 0; p < principles.length; p++) {
                tagsHtml += '<span class="tag tag-principle tag-clickable" data-route="principle/' +
                    encodeHashParam(principles[p]) + '">' + escapeHtml(principles[p]) + '</span>';
            }
            var applications = article.applications || [];
            for (var ap = 0; ap < applications.length; ap++) {
                tagsHtml += '<span class="tag tag-application tag-clickable" data-route="application/' +
                    encodeHashParam(applications[ap]) + '">' + escapeHtml(applications[ap]) + '</span>';
            }
            dom.detailTags.innerHTML = tagsHtml;

            // Keywords section
            var keywords = article.keywords || [];
            if (keywords.length > 0) {
                dom.detailKeywords.style.display = 'block';
                var kwHtml = '';
                for (var k = 0; k < keywords.length; k++) {
                    kwHtml += '<span class="tag tag-keyword tag-clickable" data-route="search/' +
                        encodeHashParam(String(keywords[k])) + '">' + escapeHtml(String(keywords[k])) + '</span>';
                }
                dom.detailKeywordsList.innerHTML = kwHtml;
            } else {
                dom.detailKeywords.style.display = 'none';
            }

            // Show detail, hide list
            dom.listView.style.display = 'none';
            dom.articleDetail.classList.add('active');

            // Show loading in body
            dom.detailBody.innerHTML = '<div class="article-loading"><div class="spinner"></div><p>Loading article&hellip;</p></div>';

            // Fetch article HTML
            fetchArticleContent(articleId);

            // Update panel active highlight
            updatePanelActiveCard();

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function fetchArticleContent(articleId) {
            var url = ARTICLES_BASE + encodeURIComponent(articleId) + '.html';
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState !== 4) return;
                if (xhr.status === 200) {
                    dom.detailBody.innerHTML = xhr.responseText;
                    if (panelMatchedTerms.length > 0) {
                        var matchCount = highlightTermInBody(panelMatchedTerms);
                        showHighlightNav(matchCount);
                        if (matchCount > 0) goToHighlight(0);
                    }
                } else if (xhr.status === 404) {
                    dom.detailBody.innerHTML = '<div class="no-results">' +
                        '<h3>Article content not available</h3>' +
                        '<p>The full text of this article has not yet been published to the archive.</p></div>';
                } else {
                    dom.detailBody.innerHTML = '<div class="loading-error">' +
                        '<strong>Error loading article</strong> (HTTP ' + xhr.status + '). ' +
                        'Please try again later.</div>';
                }
            };
            xhr.onerror = function() {
                dom.detailBody.innerHTML = '<div class="loading-error">' +
                    '<strong>Network error.</strong> Please check your connection and try again.</div>';
            };
            xhr.send();
        }

        /* ============================================================
           URL ROUTING (hash-based)
           ============================================================ */
        function buildHash() {
            var parts = [];
            if (activeFilter.type && activeFilter.value) {
                parts.push(activeFilter.type + '=' + encodeHashParam(activeFilter.value));
            }
            if (activeFilter.yearFrom) {
                parts.push('yearFrom=' + activeFilter.yearFrom);
            }
            if (activeFilter.yearTo) {
                parts.push('yearTo=' + activeFilter.yearTo);
            }
            if (activeFilter.search) {
                parts.push('search=' + encodeHashParam(activeFilter.search));
            }
            if (parts.length === 0) return '';

            // Use simple format for single legacy-style filters (backward compat)
            if (parts.length === 1 && !activeFilter.yearFrom && !activeFilter.yearTo) {
                if (activeFilter.type && !activeFilter.search) {
                    return activeFilter.type + '/' + encodeHashParam(activeFilter.value);
                }
                if (activeFilter.search && !activeFilter.type) {
                    return 'search/' + encodeHashParam(activeFilter.search);
                }
            }

            return 'filter/' + parts.join('&');
        }

        function parseHash(hash) {
            var filter = { type: null, value: null, search: '', yearFrom: '', yearTo: '' };

            if (!hash || hash === '') return filter;

            // Compound filter route
            if (hash.indexOf('filter/') === 0) {
                var paramStr = hash.substring(7);
                var pairs = paramStr.split('&');
                for (var i = 0; i < pairs.length; i++) {
                    var eqIdx = pairs[i].indexOf('=');
                    if (eqIdx === -1) continue;
                    var key = pairs[i].substring(0, eqIdx);
                    var val = decodeHashParam(pairs[i].substring(eqIdx + 1));

                    if (key === 'search') {
                        filter.search = val;
                    } else if (key === 'yearFrom') {
                        filter.yearFrom = val;
                    } else if (key === 'yearTo') {
                        filter.yearTo = val;
                    } else if (key === 'year' || key === 'principle' || key === 'application' || key === 'author') {
                        filter.type = key;
                        filter.value = val;
                    }
                }
                return filter;
            }

            // Legacy simple routes
            var slashIdx = hash.indexOf('/');
            var routeType = slashIdx > -1 ? hash.substring(0, slashIdx) : hash;
            var routeValue = slashIdx > -1 ? decodeHashParam(hash.substring(slashIdx + 1)) : '';

            if (routeType === 'search') {
                filter.search = routeValue;
            } else if (routeType === 'year' || routeType === 'principle' || routeType === 'application' || routeType === 'author') {
                filter.type = routeType;
                filter.value = routeValue;
            }
            // 'article' is handled separately before parseHash is called

            return filter;
        }

        function handleRoute() {
            var hash = window.location.hash.replace(/^#\/?/, '');

            // Article detail view
            if (hash.indexOf('article/') === 0) {
                var articleId = decodeHashParam(hash.substring(8));
                showArticleDetail(articleId);
                return;
            }

            // No longer viewing a specific article
            currentArticleId = null;
            updatePanelActiveCard();

            // Parse filter state from hash
            var parsed = parseHash(hash);
            activeFilter.type = parsed.type;
            activeFilter.value = parsed.value;
            activeFilter.search = parsed.search;
            activeFilter.yearFrom = parsed.yearFrom;
            activeFilter.yearTo = parsed.yearTo;

            // Update sidebar active state
            if (activeFilter.type && activeFilter.value) {
                var route = activeFilter.type + '/' + encodeHashParam(activeFilter.value);
                setActiveNav(route);
                if (activeFilter.type === 'principle') {
                    expandPrincipleGroup(activeFilter.value);
                } else if (activeFilter.type === 'application') {
                    expandPrincipleGroupForApplication(activeFilter.value);
                }
            } else {
                setActiveNav('');
            }

            // Update search input
            dom.searchInput.value = activeFilter.search || '';
            updateSearchClearVisibility();

            // Update date range dropdowns
            dom.yearFrom.value = activeFilter.yearFrom || '';
            dom.yearTo.value = activeFilter.yearTo || '';
            updateDateRangeClearVisibility();

            // Render
            renderListView();
        }

        /* ============================================================
           SEARCH
           ============================================================ */
        var searchDebounceTimer = null;

        function onSearchInput() {
            var query = dom.searchInput.value.trim();
            updateSearchClearVisibility();

            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(function() {
                activeFilter.search = query;
                updateHashFromFilter();
            }, 250);
        }

        function updateSearchClearVisibility() {
            dom.searchClear.style.display = dom.searchInput.value.length > 0 ? 'block' : 'none';
        }

        function clearSearch() {
            dom.searchInput.value = '';
            updateSearchClearVisibility();
            activeFilter.search = '';
            updateHashFromFilter();
        }

        /* ============================================================
           DATE RANGE
           ============================================================ */
        function onDateRangeChange() {
            activeFilter.yearFrom = dom.yearFrom.value;
            activeFilter.yearTo = dom.yearTo.value;
            updateDateRangeClearVisibility();
            updateHashFromFilter();
        }

        function clearDateRange() {
            dom.yearFrom.value = '';
            dom.yearTo.value = '';
            activeFilter.yearFrom = '';
            activeFilter.yearTo = '';
            updateDateRangeClearVisibility();
            updateHashFromFilter();
        }

        function updateDateRangeClearVisibility() {
            dom.dateRangeClear.style.display =
                (activeFilter.yearFrom || activeFilter.yearTo) ? 'block' : 'none';
        }

        /* ============================================================
           NAVIGATION HELPERS
           ============================================================ */
        function updateHashFromFilter() {
            var newHash = buildHash();
            setHash(newHash);
        }

        function setHash(hash) {
            if (hash) {
                window.location.hash = '#' + hash;
            } else {
                if (window.location.hash) {
                    window.location.hash = '';
                } else {
                    handleRoute();
                }
            }
        }

        function goBack() {
            var hash = window.location.hash.replace(/^#\/?/, '');
            if (hash.indexOf('article/') === 0) {
                if (previousHash && previousHash.indexOf('article/') !== 0) {
                    window.location.hash = '#' + previousHash;
                } else {
                    setHash('');
                }
            } else {
                setHash('');
            }
        }

        /* ============================================================
           EVENT DELEGATION
           ============================================================ */
        function handleDelegatedClick(e) {
            var target = e.target;

            while (target && target !== document.body) {
                // Search panel result card click
                var panelId = target.getAttribute('data-panel-article-id');
                if (panelId) {
                    e.preventDefault();
                    setHash('article/' + encodeHashParam(panelId));
                    // Close panel on mobile/tablet (overlay mode)
                    if (window.innerWidth <= 1200) {
                        closeSearchPanel();
                    }
                    return;
                }

                var route = target.getAttribute('data-route');
                if (route !== null) {
                    e.preventDefault();
                    closeSidebar();

                    // When clicking a sidebar filter, reset other filter state but keep date range
                    if (route === '') {
                        // Clear all
                        activeFilter.type = null;
                        activeFilter.value = null;
                        activeFilter.search = '';
                        activeFilter.yearFrom = '';
                        activeFilter.yearTo = '';
                        dom.searchInput.value = '';
                        dom.yearFrom.value = '';
                        dom.yearTo.value = '';
                        updateSearchClearVisibility();
                        updateDateRangeClearVisibility();
                    }

                    setHash(route);
                    return;
                }

                var articleId = target.getAttribute('data-article-id');
                if (articleId) {
                    e.preventDefault();
                    setHash('article/' + encodeHashParam(articleId));
                    return;
                }

                if (target.classList && target.classList.contains('article-card')) {
                    var id = target.getAttribute('data-article-id');
                    if (id) {
                        e.preventDefault();
                        setHash('article/' + encodeHashParam(id));
                        return;
                    }
                }

                target = target.parentElement;
            }
        }

        function handleDelegatedKeydown(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                var target = e.target;
                var route = target.getAttribute('data-route');
                if (route !== null) {
                    e.preventDefault();
                    closeSidebar();
                    setHash(route);
                    return;
                }
                var articleId = target.getAttribute('data-article-id');
                if (articleId) {
                    e.preventDefault();
                    setHash('article/' + encodeHashParam(articleId));
                    return;
                }
            }
        }

        /* ============================================================
           PAGINATION EVENT HANDLERS
           ============================================================ */
        function goNextPage() {
            var totalPages = Math.ceil(filteredArticles.length / PAGE_SIZE);
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderPage();
                window.scrollTo(0, 0);
            }
        }

        function goPrevPage() {
            if (currentPage > 0) {
                currentPage--;
                renderPage();
                window.scrollTo(0, 0);
            }
        }

        /* ============================================================
           SEARCH PANEL
           ============================================================ */
        var panelDebounceTimer = null;

        function openSearchPanel() {
            dom.searchPanel.classList.add('open');
            dom.searchPanelOverlay.style.display = 'block';
            dom.searchPanelOverlay.offsetHeight; // force reflow
            dom.searchPanelOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
            dom.panelSearchInput.focus();
        }

        function closeSearchPanel() {
            dom.searchPanel.classList.remove('open');
            dom.searchPanelOverlay.classList.remove('visible');
            document.body.style.overflow = '';
            setTimeout(function() {
                if (!dom.searchPanelOverlay.classList.contains('visible')) {
                    dom.searchPanelOverlay.style.display = 'none';
                }
            }, 300);
        }

        function onPanelSearchInput() {
            var query = dom.panelSearchInput.value.trim();
            dom.panelSearchClear.style.display = query.length > 0 ? 'block' : 'none';

            clearTimeout(panelDebounceTimer);
            panelDebounceTimer = setTimeout(function() {
                panelSearchQuery = query;
                executePanelSearch();
            }, 250);
        }

        function clearPanelSearch() {
            dom.panelSearchInput.value = '';
            dom.panelSearchClear.style.display = 'none';
            panelSearchQuery = '';
            panelFilteredArticles = [];
            panelMatchedTerms = [];
            dom.panelSearchCount.style.display = 'none';
            dom.panelSearchResults.innerHTML = '';
            dom.panelSearchEmpty.style.display = 'block';
            dom.panelSearchResults.appendChild(dom.panelSearchEmpty);
        }

        function executePanelSearch() {
            if (!panelSearchQuery) {
                clearPanelSearch();
                dom.panelSearchInput.focus();
                return;
            }

            // If search data not loaded yet, load it first then re-run
            if (!searchDataLoaded) {
                loadSearchData(function() {
                    executePanelSearch();
                });
                return;
            }

            var parsed = parseSearchQuery(panelSearchQuery, currentSearchMode);
            if (parsed.clauses.length === 0) {
                clearPanelSearch();
                return;
            }

            var results = [];

            for (var i = 0; i < catalog.articles.length; i++) {
                var a = catalog.articles[i];
                var bodyText = (searchData && searchData[a.id] || '').toLowerCase();
                var result = matchArticle(a, parsed, bodyText);
                if (result.matched) {
                    results.push({ article: a, score: result.score, matchedTerms: result.matchedTerms });
                }
            }

            // Sort by score desc, then date desc
            results.sort(function(a, b) {
                if (b.score !== a.score) return b.score - a.score;
                return (b.article.date || '').localeCompare(a.article.date || '');
            });

            panelFilteredArticles = results.map(function(r) { return r.article; });

            // Collect unique matched terms for highlighting
            panelMatchedTerms = [];
            var seen = {};
            for (var i = 0; i < parsed.clauses.length; i++) {
                var c = parsed.clauses[i];
                if (c.negate) continue;
                var terms = [];
                if (c.type === 'proximity') {
                    terms = c.terms;
                } else {
                    var t = c.raw || c.term || (c.prefix ? c.prefix + '*' : null);
                    if (t) terms = [t];
                }
                for (var j = 0; j < terms.length; j++) {
                    if (!seen[terms[j]]) {
                        seen[terms[j]] = true;
                        panelMatchedTerms.push(terms[j]);
                    }
                }
            }

            renderPanelResults(panelFilteredArticles, panelMatchedTerms);
        }

        function renderPanelResults(articles, matchedTerms) {
            dom.panelSearchEmpty.style.display = 'none';

            // Show count
            dom.panelSearchCount.style.display = 'block';
            dom.panelSearchCount.textContent = articles.length + ' result' + (articles.length !== 1 ? 's' : '');

            if (articles.length === 0) {
                dom.panelSearchResults.innerHTML = '<div class="search-panel-empty"><p>No articles match "<strong>' +
                    escapeHtml(panelSearchQuery) + '</strong>"</p></div>';
                return;
            }

            // Render compact cards (cap at 100 for performance)
            var limit = Math.min(articles.length, 100);
            var html = '';
            for (var i = 0; i < limit; i++) {
                var a = articles[i];
                var isActive = (a.id === currentArticleId) ? ' active' : '';

                var meta = [];
                if (a.author) meta.push(escapeHtml(a.author));
                if (a.date) meta.push(formatDate(a.date));

                var snippet = getSearchSnippet(a.id, matchedTerms);
                var snippetHtml = snippet
                    ? '<div class="search-panel-card-snippet">' + snippet + '</div>'
                    : '';

                html += '<div class="search-panel-card' + isActive + '" data-panel-article-id="' + escapeHtml(a.id) + '">' +
                    '<div class="search-panel-card-title">' + escapeHtml(a.title) + '</div>' +
                    '<div class="search-panel-card-meta">' + meta.join(' &bull; ') + '</div>' +
                    snippetHtml +
                    '</div>';
            }

            if (articles.length > limit) {
                html += '<div style="text-align:center;padding:0.75rem;font-size:0.8rem;color:var(--color-text-muted);">' +
                    (articles.length - limit) + ' more results&hellip;</div>';
            }

            dom.panelSearchResults.innerHTML = html;
        }

        function updatePanelActiveCard() {
            var cards = dom.panelSearchResults.querySelectorAll('.search-panel-card');
            for (var i = 0; i < cards.length; i++) {
                var cardId = cards[i].getAttribute('data-panel-article-id');
                if (cardId === currentArticleId) {
                    cards[i].classList.add('active');
                } else {
                    cards[i].classList.remove('active');
                }
            }
        }

        /* ============================================================
           INITIALIZATION
           ============================================================ */
        function init() {
            cacheDom();

            // Event listeners
            dom.searchInput.addEventListener('input', onSearchInput);
            dom.searchClear.addEventListener('click', clearSearch);
            dom.prevBtn.addEventListener('click', goPrevPage);
            dom.nextBtn.addEventListener('click', goNextPage);
            dom.detailBackBtn.addEventListener('click', goBack);
            dom.yearFrom.addEventListener('change', onDateRangeChange);
            dom.yearTo.addEventListener('change', onDateRangeChange);
            dom.dateRangeClear.addEventListener('click', clearDateRange);
            dom.hamburgerBtn.addEventListener('click', function() {
                if (dom.sidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
            dom.sidebarOverlay.addEventListener('click', closeSidebar);

            // Search mode pill events
            dom.searchPanelModes.addEventListener('click', function(e) {
                var pill = e.target.closest('.search-mode-pill');
                if (!pill) return;
                currentSearchMode = pill.getAttribute('data-mode');
                var pills = dom.searchPanelModes.querySelectorAll('.search-mode-pill');
                for (var i = 0; i < pills.length; i++) pills[i].classList.remove('active');
                pill.classList.add('active');
                if (panelSearchQuery) executePanelSearch();
            });

            // Search field checkbox events
            dom.searchFields.addEventListener('change', function(e) {
                if (e.target.type !== 'checkbox') return;
                searchFields[e.target.value] = e.target.checked;
                if (panelSearchQuery) executePanelSearch();
            });

            // Highlight navigation events
            dom.highlightPrev.addEventListener('click', prevHighlight);
            dom.highlightNext.addEventListener('click', nextHighlight);
            dom.highlightClose.addEventListener('click', clearHighlights);

            // Search panel events
            dom.panelSearchInput.addEventListener('input', onPanelSearchInput);
            dom.panelSearchClear.addEventListener('click', clearPanelSearch);
            dom.searchToggleBtn.addEventListener('click', function() {
                if (dom.searchPanel.classList.contains('open')) {
                    closeSearchPanel();
                } else {
                    openSearchPanel();
                }
            });
            dom.searchPanelClose.addEventListener('click', closeSearchPanel);
            dom.searchPanelOverlay.addEventListener('click', closeSearchPanel);

            // Global delegated click/keydown
            document.addEventListener('click', handleDelegatedClick);
            document.addEventListener('keydown', handleDelegatedKeydown);

            // Hash change for back/forward
            window.addEventListener('hashchange', function() {
                var newHash = window.location.hash.replace(/^#\/?/, '');
                handleRoute();
                previousHash = newHash;
            });

            // Track initial hash
            previousHash = window.location.hash.replace(/^#\/?/, '');

            // Load catalog
            loadCatalog();
        }

        // Start on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
